{% extends 'base.html' %}

{% block title %}Web Scraper{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Web Presence Scraper</h1>
    <p class="lead">Analyze your website content to identify brand voice patterns and consistency.</p>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header card-header-feature">
                <h2 class="h4 mb-0"><i class="fas fa-globe icon-primary me-2"></i> Website Analysis</h2>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="info-card">
                            <h5><i class="fas fa-check-circle icon-accent me-2"></i> What We Analyze</h5>
                            <ul>
                                <li>Text content from your website</li>
                                <li>Brand voice patterns and consistency</li>
                                <li>Key parameters from your real-world usage</li>
                                <li>Strong examples of your current brand voice</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-card">
                            <h5><i class="fas fa-info-circle icon-accent me-2"></i> For Best Results</h5>
                            <ul>
                                <li>Enter your main website URL</li>
                                <li>Ensure the site has sufficient text content</li>
                                <li>The system works best on content-rich pages</li>
                                <li>Make sure your website is publicly accessible</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form action="{{ url_for('web_scraper_bp.index') }}" method="post" class="mt-4">
                    <!-- Simple test form -->
                    <div class="form-group">
                        <label for="url" class="form-label">Enter your website URL</label>
                        <div class="input-with-icon">
                            <i class="fas fa-globe"></i>
                            <input type="text" class="form-control" id="url" name="website_url" placeholder="Enter your website URL (e.g., apple.com)" required>
                        </div>
                        <div class="form-text">Enter your website domain (e.g., apple.com, nike.com). No need to include http:// or https://</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="submit" class="btn btn-primary" id="analyze-button">
                            <i class="fas fa-search"></i> Analyze Website
                        </button>
                    </div>

                    <!-- Progress indicator (hidden by default) -->
                    <div id="progress-container" class="mt-4 d-none">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-spinner fa-spin me-2"></i> Analysis in Progress</h5>
                                <div class="progress mb-3">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div id="progress-status">Initializing...</div>
                                <div class="small text-muted mt-2">This may take a few minutes depending on the website size and complexity.</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="feature-section mt-5">
    <h2 class="h4 mb-3">How Web Scraping Works</h2>
    <div class="row">
        <div class="col-md-3 mb-3">
            <div class="feature-card h-100">
                <i class="fas fa-spider icon-accent feature-card-icon"></i>
                <h5 class="card-title">Content Scraping</h5>
                <p class="card-text">Our system visits your website and extracts text content from the page.</p>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="feature-card h-100">
                <i class="fas fa-filter icon-accent feature-card-icon"></i>
                <h5 class="card-title">Text Processing</h5>
                <p class="card-text">The extracted text is cleaned and processed for analysis.</p>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="feature-card h-100">
                <i class="fas fa-chart-pie icon-accent feature-card-icon"></i>
                <h5 class="card-title">Pattern Analysis</h5>
                <p class="card-text">We analyze the text for patterns in language, tone, and style.</p>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="feature-card h-100">
                <i class="fas fa-cogs icon-accent feature-card-icon"></i>
                <h5 class="card-title">Parameter Extraction</h5>
                <p class="card-text">Key brand voice parameters are identified and quantified.</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header card-header-feature">
                <h3 class="h5 mb-0"><i class="fas fa-unlock-alt icon-primary me-2"></i> Advanced Web Scraping Settings</h3>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="info-card">
                            <h5><i class="fas fa-info-circle icon-accent me-2"></i> About Web Unlocker</h5>
                            <p>The Brightdata Web Unlocker API helps access websites that are difficult to scrape due to:</p>
                            <ul>
                                <li>Anti-bot protection</li>
                                <li>CAPTCHA challenges</li>
                                <li>IP blocking</li>
                                <li>SSL certificate issues</li>
                                <li>JavaScript-rendered content</li>
                            </ul>
                            <p>This is an optional service that requires a Brightdata account and API key.</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-card">
                            <h5><i class="fas fa-cogs icon-accent me-2"></i> How It Works</h5>
                            <p>When enabled, the Web Unlocker API will be used as a fallback when our regular scraping methods fail. It provides:</p>
                            <ul>
                                <li>Automatic CAPTCHA solving</li>
                                <li>Browser fingerprint emulation</li>
                                <li>IP rotation from residential networks</li>
                                <li>JavaScript rendering</li>
                                <li>Cookie and header management</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form action="{{ url_for('web_scraper_bp.index') }}" method="post" class="mt-4">
                    <input type="hidden" name="brightdata_form" value="1">
                    <div class="form-group mb-4">
                        <label for="api_key" class="form-label">Brightdata API Key</label>
                        <div class="input-with-icon">
                            <i class="fas fa-key"></i>
                            <input type="password" class="form-control" id="api_key" name="api_key"
                                value="{{ brightdata_settings.api_key if brightdata_settings and brightdata_settings.api_key else '' }}"
                                placeholder="Enter your Brightdata Web Unlocker API key">
                        </div>
                        <div class="form-text">Your API key can be found in your Brightdata dashboard.</div>
                    </div>

                    <div class="form-group mb-4">
                        <label for="zone" class="form-label">Zone Name (Optional)</label>
                        <div class="input-with-icon">
                            <i class="fas fa-globe"></i>
                            <input type="text" class="form-control" id="zone" name="zone"
                                value="{{ brightdata_settings.zone if brightdata_settings and brightdata_settings.zone else 'web_unlocker1' }}"
                                placeholder="Enter your Brightdata zone name">
                        </div>
                        <div class="form-text">Default is "web_unlocker1". Change only if you have a custom zone.</div>
                    </div>

                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" id="enabled" name="enabled"
                            {% if brightdata_settings and brightdata_settings.enabled %}checked{% endif %}>
                        <label class="form-check-label" for="enabled">Enable Brightdata Web Unlocker API</label>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Using the Brightdata Web Unlocker API may incur additional costs based on your Brightdata account plan.
                        The API will only be used as a fallback when regular scraping methods fail.
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="h5 mb-0">Privacy & Security</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-shield-alt icon-accent me-2"></i> How We Handle Your Data</h5>
                        <ul>
                            <li>We only analyze publicly available content from your website</li>
                            <li>We do not store the raw content from your website</li>
                            <li>Only the extracted parameters are saved in your session</li>
                            <li>Your data is not shared with third parties</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-exclamation-triangle icon-accent me-2"></i> Limitations</h5>
                        <ul>
                            <li>We can only analyze publicly accessible pages</li>
                            <li>Password-protected content cannot be accessed</li>
                            <li>JavaScript-rendered content may not be fully captured</li>
                            <li>Some websites may block web scraping attempts</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlInput = document.getElementById('url');
        const analyzeButton = document.getElementById('analyze-button');
        const form = document.querySelector('form');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');

        // Validate URL as user types
        urlInput.addEventListener('input', function() {
            const url = this.value.trim();
            // Simple regex for domain validation
            const isValid = /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/.test(url) ||
                           /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)$/.test(url);

            if (url === '') {
                this.classList.remove('is-valid', 'is-invalid');
                analyzeButton.disabled = false;
            } else if (isValid) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                analyzeButton.disabled = false;
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                analyzeButton.disabled = true;
            }
        });

        form.addEventListener('submit', function(e) {
            // Validate URL before submission
            const url = urlInput.value.trim();
            if (!url) {
                e.preventDefault();
                urlInput.classList.add('is-invalid');
                return false;
            }

            // Show loading state
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Initializing...';

            // Show progress container
            progressContainer.classList.remove('d-none');

            // Simulate progress updates
            let progress = 0;
            const progressInterval = setInterval(function() {
                // Increment progress
                if (progress < 90) {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90; // Cap at 90% until complete

                    // Update progress bar
                    progressBar.style.width = progress + '%';

                    // Update status message based on progress
                    if (progress < 20) {
                        progressStatus.innerHTML = 'Connecting to website...';
                    } else if (progress < 40) {
                        progressStatus.innerHTML = 'Extracting content from main page...';
                    } else if (progress < 60) {
                        progressStatus.innerHTML = 'Finding and analyzing internal pages...';
                    } else if (progress < 80) {
                        progressStatus.innerHTML = 'Processing text content...';
                    } else {
                        progressStatus.innerHTML = 'Analyzing brand voice patterns...';
                    }
                }
            }, 800);

            // Store the interval ID in sessionStorage so we can clear it if the page is reloaded
            sessionStorage.setItem('progressInterval', progressInterval);

            // Let the form submit
            return true;
        });
    });
</script>
{% endblock %}
